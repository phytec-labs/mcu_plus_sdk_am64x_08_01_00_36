<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: Enabling XIP or eXecute In Place</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">08.01.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('BOOTFLOW_XIP.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Enabling XIP or eXecute In Place </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md179">Introduction</a></li>
<li class="level1"><a href="#autotoc_md180">Additional References</a></li>
<li class="level1"><a href="#autotoc_md181">Pre-requisites</a></li>
<li class="level1"><a href="#autotoc_md182">Enable XIP for a application</a></li>
<li class="level1"><a href="#autotoc_md183">Debugging XIP applications</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_developer_guides_bootflow_xip"></a></p>
<h1><a class="anchor" id="autotoc_md179"></a>
Introduction</h1>
<ul>
<li>Normally, when running a application, the application code is first copied to RAM by bootloader and then code executes from RAM.</li>
<li>XIP or eXecute In Place allows a application to execute part of the code from flash without having to copy to RAM.</li>
<li>Advantage is, this allows users to have a larger code size limited by flash size rather than limited by RAM size.</li>
<li>Disadvantage is,<ul>
<li>The flash memory is typically slower (~300MB/s bandwidth) vs RAM memory ( &gt; 1600 MB/s),</li>
<li>Due to this, execution speed, esp when code is not cached in the CPU cache, will be slower as compared to when executing from RAM.</li>
</ul>
</li>
<li>However in some situations it is needed to execute code from flash for non-real time, non high performance code.</li>
<li>XIP allows to do this.</li>
</ul>
<h1><a class="anchor" id="autotoc_md180"></a>
Additional References</h1>
<p>See also these additional pages for more details and examples about XIP,</p>
<ul>
<li>To understand and run a example in XIP mode see<ul>
<li><a class="el" href="EXAMPLES_KERNEL_DPL_XIP_BENCHMARK.html">XIP Benchmark</a></li>
</ul>
</li>
<li>To understand overall boot flow see, <a class="el" href="BOOTFLOW_GUIDE.html">Understanding the bootflow and bootloaders</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md181"></a>
Pre-requisites</h1>
<ul>
<li>The flash memory should be visible to the CPU, in "direct access mode (DAC)" i.e memory mapped mode.<ul>
<li>Here the contents of the flash can be read as any other memory region.</li>
<li>This typically is a "read-only" memory</li>
</ul>
</li>
<li>The secondary bootloader needs to enable flash at highest throughput mode in this DAC mode, before booting the application.</li>
<li>The application entry point, interrupt vectors and initial code upto <code>main()</code> should still execute from RAM. After <code>main()</code> the code can execute from flash.</li>
</ul>
<h1><a class="anchor" id="autotoc_md182"></a>
Enable XIP for a application</h1>
<p>To enable XIP for a application, below changes need to be done,</p>
<ul>
<li>Enable cache for the XIP flash region. This is need to get better performance for the XIP execution<ul>
<li>On R5F, this is done by adding a MPU entry for region <code>0x60000000</code> of size 256MB. This can be done via SysConfig.</li>
<li>If a CPU, say M4F, does not have any cache, then recommend to not use XIP for that CPU.</li>
<li>A sample MPU setting on AM64x, AM243x SOC done via SysConfig is shown below.<ul>
<li>Make sure to enable code execution, and cache for this region.</li>
</ul>
</li>
</ul>
</li>
</ul>
<p> <style>div.image img[src="bootflow_xip_mpu_setup.png"]{width:60%}</style> </p><div class="image">
<img src="bootflow_xip_mpu_setup.png" alt=""/>
<div class="caption">
Flash section in R5F MPU</div></div>
<ul>
<li>Update the linker command file to re-direct required <code>.text</code> and <code>.rodata</code> sections to <code>FLASH</code> region as shown below <div class="fragment"><div class="line">SECTIONS {</div>
<div class="line">    ...</div>
<div class="line">    GROUP {</div>
<div class="line">        .text:   {} palign(8)   /* This is where code resides */</div>
<div class="line">        .rodata: {} palign(8)   /* This is where const&#39;s go */</div>
<div class="line">    } &gt; FLASH</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">MEMORY</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">    FLASH     : ORIGIN = 0x60100000 , LENGTH = 0x80000</div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>The same process can be repeated for multiple CPUs if needed, only make sure the <code>FLASH</code> defined in <code>MEMORY { ... }</code> for the linker command files of each CPU are non-overlapping.</li>
<li><b>NOTE</b>, when multiple CPUs run using XIP, the overall available flash bandwidth get split across multi-CPUs. So the overall performance will degrade vs using single CPU in XIP mode. However, functionally nothing restricts such a mode of operation.</li>
<li>As part of post build step, one extra step is run as compared to non-XIP case, as listed below<ul>
<li><code>xipGen</code> tool is used to split the application into non-XIP and XIP sections</li>
</ul>
</li>
<li>The file containing XIP sections is additionally flashed to the flash using the special <code>flash-xip</code> command passed to the flash writer</li>
<li><b>NOTE</b>, the secondary bootloader remains exactly the same when running applications in XIP or non-XIP mode.</li>
<li>For all the SDK examples<ul>
<li>The linker command is updated to include the <code>FLASH</code> memory segment. The code/rodata section are NOT re-directed to FLASH by default though, unless mentioned otherwise in the example.</li>
<li>XIP post-build steps are always invoked as part of application post build. Invoking these steps even though there is no XIP section has no side effect.</li>
<li>The default flash writer config file has the flashing command needed to flash the XIP sections. Again, if XIP sections are not present there is no side effect on normal non-XIP operation.</li>
</ul>
</li>
<li>Thus, all one needs to do to enable XIP is<ul>
<li>Add a MPU/MMU entry to mark the flash region as executable + cached</li>
<li>And update the linker command to mark the code/rodata sections as <code>FLASH</code> instead of RAM.</li>
<li>Rest of the steps remain exactly the same as non-XIP case.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md183"></a>
Debugging XIP applications</h1>
<ul>
<li>XIP applications can not be loaded via CCS, hence to debug a XIP application one needs to always flash and run the application and then "load symbols" via CCS to debug the application</li>
<li>Another alternative is develop and debug the application with all code in "RAM" and then just update the linker command to use "FLASH" and do the final test or debug with application in XIP mode.</li>
<li>The CCS option to load symbols is shown below,</li>
</ul>
<p> <style>div.image img[src="bootflow_xip_load_symbols.png"]{width:60%}</style> </p><div class="image">
<img src="bootflow_xip_load_symbols.png" alt=""/>
<div class="caption">
CCS Load Symbols</div></div>
<ul>
<li>Normal "SW" breakpoints in CCS wont work for code in flash, and "HW" breakpoints should be used.<ul>
<li>To put a breakpoint CCS needs to write a special instruction at the point in code,</li>
<li>However since the flash memory is "read-only", this will result in a error, hence one should use "HW" breakpoints instead</li>
</ul>
</li>
<li>Below shows a example of putting a HW breakpoint,</li>
</ul>
<p> <style>div.image img[src="bootflow_xip_hw_break_point.png"]{width:60%}</style> </p><div class="image">
<img src="bootflow_xip_hw_break_point.png" alt=""/>
<div class="caption">
HW Breakpoint</div></div>
<ul>
<li>When prompted enter the function name on which you want the breakpoint to hit. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
