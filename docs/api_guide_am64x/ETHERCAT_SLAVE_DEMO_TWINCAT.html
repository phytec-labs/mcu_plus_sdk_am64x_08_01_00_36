<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: EtherCAT Slave Setup with TwinCAT</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">08.01.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ETHERCAT_SLAVE_DEMO_TWINCAT.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">EtherCAT Slave Setup with TwinCAT </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_examples_industrial_comms_ethercat_slave_beckhoff_ssc_demo_twincat"></a> </p>
<h1><a class="anchor" id="ETHERCAT_SLAVE_DEMO_TWINCAT_PROJECT_CREATION"></a>
Creating TwinCAT Project</h1>
<ul>
<li>Install TwinCAT3. A 7 days free trial license is available for free download from the <a href="http://www.beckhoff.co.in/english.asp?download/tc3-download-xae.htm">Beckhoff's website</a>. Select the eXtended Automation Engineering (XAE) mode of installation.</li>
<li>Copy the ESI file to <code>{TWINCAT_INSTALL_DIR}\TwinCAT\3.1\Config\Io\EtherCAT</code> folder.<ul>
<li>ESI file for EtherCAT Slave application based on ETG stack is <code>${SDK_INSTALL_PATH}/source/industrial_comms/ethercat_slave/beckhoff_stack/esi/TI_ESC.xml</code></li>
</ul>
</li>
<li>Start the TwinCAT XAE Shell application.</li>
<li><p class="startli">Create a new TwinCAT XAE Project (XML format) by going to "File -&gt; New -&gt; Project -&gt; TwinCAT Project"</p>
<div class="image">
<img src="EtherCAT_Slave_TwinCAT_Project_Create.PNG" alt=""/>
<div class="caption">
Creating a new TwinCAT Project</div></div>
</li>
<li><p class="startli">Go to "TwinCAT -&gt; Show Realtime Ethernet Compatible Devices" and install TwinCAT RT Ethernet intermediate driver. For best performance, it is recommended to use a compatible NIC card listed in <a href="https://infosys.beckhoff.com/english.php?content=../content/1033/tc3_overview/9309844363.html&amp;id=1489698440745036069">Supported network controllers</a> . For the first time only you need to do this for the PC's Ethernet port, which is used as the EtherCAT port. Go to "TwinCAT -&gt; Show Realtime Ethernet Compatible Devices" and check if the ethernet adapter is listed below "Installed and ready to use devices" before attempting to scan the slave.</p>
<table style="border: 0 px; margin-left: auto; margin-right: auto">
<tr>
<td><div class="image">
<img src="EtherCAT_Slave_TwinCAT_NIC_Detection.PNG" alt=""/>
</div>
  </td><td><div class="image">
<img src="EtherCAT_Slave_TwinCAT_NIC_Detection_2.PNG" alt=""/>
</div>
   </td></tr>
</table>
</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>If your computer go to sleep and after awake it TwinCAT lost connection with slave(s) and/or is not able to discover EtherCAT IO devices, you can fix this issue by going in TwinCAT to your Ethernet adapters, and disabling / enabling your NIC.</dd></dl>
<ul>
<li><p class="startli">Connect Ethernet cable from PC running TwinCAT to EtherCAT IN/Port0 of the PRU-ICSS on the EVM. If you have multiple devices in chain, please connect from EtherCAT OUT/Port1 to IN/Port0 of next device. For the last device in chain, OUT/Port1 will be left open (if NOT using redundancy mode).</p>
<div class="image">
<img src="ethercat_slave_ports.png" alt=""/>
</div>
</li>
</ul>
<h1><a class="anchor" id="ETHERCAT_SLAVE_DEMO_TWINCAT_SCANNING_SLAVE"></a>
Scanning the slave</h1>
<ul>
<li>On powering up the EVM and loading the application, you should see digital output LEDs 2, 4, 6 and 7 on. This indicates that slave is up and in INIT state.</li>
<li><p class="startli">In Solution Explorer, go to "TwinCAT project -&gt; I/O -&gt; Devices". Right click on Devices and select Scan. Press OK in the next dialog to start scanning for EtherCAT devices.</p>
<div class="image">
<img src="EtherCAT_Slave_TwinCAT_Slave_Detection.PNG" alt=""/>
</div>
</li>
<li><p class="startli">Once an EtherCAT compatible device has been detected on this Ethernet port, the following dialog shows up. Note that there is a tick mark next to the adapter to which the EVM is connected. Press OK and confirm to start "Scan for boxes".</p>
<div class="image">
<img src="EtherCAT_Slave_TwinCAT_Slave_Detection_2.PNG" alt=""/>
</div>
</li>
<li><p class="startli">TI Box n(TIESC) will be detected automatically. The TI device will be listed "Box n (TIESC-*)". Press Yes to activate Free Run. This will put TI ESC into OP mode. TIESC number is based on the platform and application. Please check the ESI file for more details.</p>
<div class="image">
<img src="EtherCAT_Slave_TwinCAT_Slave_Detection_3.PNG" alt=""/>
</div>
</li>
<li><p class="startli">The EtherCAT device state can be displayed by selecting a Device (Double click on Device) and then selecting the Online tab. The device should be in the OP state with no Lost Frames or Tx/Rx Errors.</p>
<div class="image">
<img src="EtherCAT_Slave_TwinCAT_Slave_Detection_4.PNG" alt=""/>
</div>
</li>
<li><p class="startli">The user can control 8 digital out LEDs using TwinCAT. LED[0] to LED[7] in "Box n (TIESC-*) -&gt; DO Outputs -&gt; LED". Each LED can be turned on and off by selecting "Online write 1" and "Online write 0" respectively.</p>
<div class="image">
<img src="EtherCAT_Slave_TwinCAT_Slave_Detection_5.PNG" alt=""/>
</div>
</li>
<li>Above steps test the slave in Free Run Operation Mode. For testing Distributed Clock (DC) Synchronization mode, refer to the <a class="el" href="ETHERCAT_SLAVE_DEMO_TWINCAT.html#ETHERCAT_SLAVE_DEMO_TWINCAT_DC_MODE_TESTING">Testing DC Synchronization mode</a> section.</li>
</ul>
<h1><a class="anchor" id="ETHERCAT_SLAVE_DEMO_TWINCAT_DC_MODE_TESTING"></a>
Testing DC Synchronization mode</h1>
<ul>
<li>Launch TwinCAT XAE Shell application and discover all the slaves in slave chain. Multiple slaves are required to make use of distributed clocks. Here, we used two devices in the chain.</li>
<li><p class="startli">Choose DC Synchronization for all devices in the chain. Click on Box n (TIESC-*). Open the DC tab, and choose DC-Synchron option in Operation Mode. Do this for all slaves in the chain.</p>
<div class="image">
<img src="EtherCAT_Slave_DC_Mode.PNG" alt=""/>
</div>
</li>
<li><p class="startli">In Solution Explorer, go to TwinCAT project, select "SYSTEM -&gt; Real-Time". In the Settings tab, choose the desired Base Time. With compatible NIC cards, a base time of as low as 50 us can be chosen.</p>
<div class="image">
<img src="EtherCAT_Slave_DC_Mode_2.PNG" alt=""/>
</div>
</li>
<li><p class="startli">Right-click on "SYSTEM -&gt; Tasks". Click "Add New Item" on the pop-up menu. Select "TwinCAT Image with Task" in the next dialog box. Type a name for the task, and choose OK.</p>
<table style="border: 0 px; margin-left: auto; margin-right: auto">
<tr>
<td><div class="image">
<img src="EtherCAT_Slave_DC_Mode_3.PNG" alt=""/>
</div>
  </td><td><div class="image">
<img src="EtherCAT_Slave_DC_Mode_4.PNG" alt=""/>
</div>
   </td></tr>
</table>
</li>
<li>In the "Task" tab for the created task, select Auto Priority Management. Press OK in dialog box saying "Global Priority Management should be turned on".</li>
<li><p class="startli">Choose "Auto start" for the task. Choose 2 cycle ticks’ frequency for the task.</p>
<div class="image">
<img src="EtherCAT_Slave_DC_Mode_5.PNG" alt=""/>
</div>
</li>
<li><p class="startli">Add an output variable to the task. Right-click on "[Task name] -&gt; Outputs", and choose "Add New Item". You may choose default options for the variable.</p>
<div class="image">
<img src="EtherCAT_Slave_DC_Mode_6.PNG" alt=""/>
</div>
</li>
<li><p class="startli">Link the variable to an output for the last slave in the chain. Right-click on [Variable name], and choose "Change Link...".</p>
<div class="image">
<img src="EtherCAT_Slave_DC_Mode_7.PNG" alt=""/>
</div>
</li>
<li><p class="startli">Choose an output from the last slave. You may need to choose "All Types" in "Show Variable Types".</p>
<div class="image">
<img src="EtherCAT_Slave_DC_Mode_8.PNG" alt=""/>
</div>
</li>
<li>You can launch into Run mode by clicking the <img src="EtherCAT_Slave_DC_Mode_9.PNG" alt="" class="inline"/>    "Activate Configuration" button on the toolbar.</li>
<li>Choose Yes to generate mapping after modifying configuration, click on OK to "Activate Configuration?", and Yes to Restart in RUN mode.</li>
</ul>
<h1><a class="anchor" id="autotoc_md1142"></a>
Generating ESI Header file From ESI XML file</h1>
<p><a class="el" href="EXAMPLES_INDUSTRIAL_COMMS_ETHERCAT_SLAVE_BECKHOFF_SSC_DEMO.html">EtherCAT Slave Beckhoff SSC Example</a> is expected to be used with <code>${SDK_INSTALL_PATH}/source/industrial_comms/ethercat_slave/beckhoff_stack/esi/TI_ESC.xml</code> file. If the application is modified to work with a different ESI XML file, user will need to update the corresponding ESI header file (tiesc_eeprom.h) and rebuild the application project.</p>
<ul>
<li>Generate the binary file equivalent to ESI XML file:<ul>
<li>Configure TwinCAT as mentioned in <a class="el" href="ETHERCAT_SLAVE_DEMO_TWINCAT.html#ETHERCAT_SLAVE_DEMO_TWINCAT_PROJECT_CREATION">Creating TwinCAT Project</a> and <a class="el" href="ETHERCAT_SLAVE_DEMO_TWINCAT.html#ETHERCAT_SLAVE_DEMO_TWINCAT_SCANNING_SLAVE">Scanning the slave</a>.</li>
<li>Click on the TI Box. Select "EtherCAT" Tab. Click on the "Advanced Settings" button.</li>
<li>Select "ESC Access -&gt; E2PROM -&gt; Hex Editor". Select "Write to File" and save the binary as a ".bin" file.</li>
</ul>
</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Please make sure that "Upload" button is not clicked any time during this step. It will load the EEPROM data from TI ESC to TwinCAT memory.</dd></dl>
<ul>
<li>Convert the binary file to header file using the bin2c tool. This tool can be found in <code>${SDK_INSTALL_PATH}/tools/bin2c</code> folder. Example usage is shown below. <div class="fragment"><div class="line">python ${SDK_INSTALL_PATH}/tools/bin2c/bin2c.py &quot;Box 1 (TIESC-004).bin&quot; new_tiesc_eeprom.c new_tiesc_eeprom</div>
</div><!-- fragment --></li>
<li>Replace the contents within <code>"const unsigned char tiesc_eeprom[]"</code> array in <code>${SDK_INSTALL_PATH}/examples/industrial_comms/ethercat_slave_beckhoff_ssc_demo/am64x-evm/tiesc_eeprom.h</code> file with the data generated in <code>new_tiesc_eeprom.h</code> file within the brackets following <code>"#define NEW_TIESC_EEPROM"</code>.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Please do not directly replace the existing <code>tiesc_eeprom.h</code> file with new header file.</dd></dl>
<ul>
<li>Rebuild the application.</li>
</ul>
<h1><a class="anchor" id="autotoc_md1143"></a>
Online Application Upgrade</h1>
<dl class="section note"><dt>Note</dt><dd>Application should be loaded with <a class="el" href="EXAMPLES_DRIVERS_SBL_OSPI.html">SBL OSPI</a> method to test this feature using following steps</dd></dl>
<ul>
<li>Configure TwinCAT as mentioned in <a class="el" href="ETHERCAT_SLAVE_DEMO_TWINCAT.html#ETHERCAT_SLAVE_DEMO_TWINCAT_PROJECT_CREATION">Creating TwinCAT Project</a> and <a class="el" href="ETHERCAT_SLAVE_DEMO_TWINCAT.html#ETHERCAT_SLAVE_DEMO_TWINCAT_SCANNING_SLAVE">Scanning the slave</a>.</li>
<li>Click on TI Box. Select "Online" tab.</li>
<li><p class="startli">Click "Bootstrap" button. This will take the Slave to BOOT state.</p>
<div class="image">
<img src="EtherCAT_Slave_FOE_1.PNG" alt=""/>
</div>
</li>
<li><p class="startli">Once the state has changed to "BOOT", Click "Download" button.</p>
<div class="image">
<img src="EtherCAT_Slave_FOE_2.PNG" alt=""/>
</div>
</li>
<li><p class="startli">Rename your EtherCAT application binary (.appimage file) as <code>ECATFW__</code>, and use this file as your new EtherCAT application.</p>
<div class="image">
<img src="EtherCAT_Slave_FOE_3.PNG" alt=""/>
</div>
</li>
<li>Locate the new application to be dowloaded click "Open".</li>
<li><p class="startli">Click OK on the new dialog shown.</p>
<div class="image">
<img src="EtherCAT_Slave_FOE_4.PNG" alt=""/>
</div>
</li>
<li>This will download the new application. The progress bar will show the status of download.</li>
<li>Once the download has finished, change the state back to "Init" by clicking "Init" button.</li>
<li><p class="startli">Perform a warm reset by writing "RST"(0x545352) or "rst"(0x747372) to ESC Reset(0x0E14-0x0E17) register to reload the application. Power restart of the EVM will also load the new application.</p>
<div class="image">
<img src="EtherCAT_Slave_FOE_5.PNG" alt=""/>
</div>
 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
