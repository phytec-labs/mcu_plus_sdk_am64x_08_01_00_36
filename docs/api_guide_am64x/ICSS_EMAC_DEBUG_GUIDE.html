<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: ICSS-EMAC Debug Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">08.01.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('ICSS_EMAC_DEBUG_GUIDE.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ICSS-EMAC Debug Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md732">Assumption</a></li>
<li class="level1"><a href="#autotoc_md733">Scope</a></li>
<li class="level1"><a href="#autotoc_md734">Common Debugging Tasks</a><ul><li class="level2"><a href="#autotoc_md735">Loading and running on CCS</a></li>
<li class="level2"><a href="#ICSS_EMAC_DEBUG_GUIDE_CHECKING_LINK_STATUS">Checking Link Status</a></li>
<li class="level2"><a href="#autotoc_md736">Checking if Receive is working</a></li>
<li class="level2"><a href="#autotoc_md737">Checking if Transmit is working</a></li>
<li class="level2"><a href="#ICSS_EMAC_DEBUG_GUIDE_CHECKING_STATISTICS">Checking Statistics</a></li>
</ul>
</li>
<li class="level1"><a href="#ICSS_EMAC_DEBUG_GUIDE_ACCESSING_MEMORY">Accessing Memory</a></li>
<li class="level1"><a href="#autotoc_md738">Using ROV to Debug RTOS</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_components_networking_icss_emac_debug_guide"></a></p>
<p>It is highly recommended to go through <a class="el" href="ICSS_EMAC_DESIGN.html">ICSS-EMAC Design</a> page before proceeding with this page.</p>
<h1><a class="anchor" id="autotoc_md732"></a>
Assumption</h1>
<ul>
<li>A basic understanding of ICSS Architecture and SoC</li>
<li>Some level of familiarity with Ethernet driver development</li>
<li>In addition to this a basic familiarity with the following tools<ul>
<li>Code Composer Studio</li>
<li>Any serial terminal (Putty/Tera Term/Terminal integrated with CCS)</li>
<li>Wireshark or any other packet sniffing tool</li>
<li>Any PC based tool capable of sending packets</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md733"></a>
Scope</h1>
<p>This page is meant to help the developer in</p><ul>
<li>Familiarizing with common debugging tools and techniques</li>
<li>Identifying and resolving frequently faced issues</li>
</ul>
<h1><a class="anchor" id="autotoc_md734"></a>
Common Debugging Tasks</h1>
<h2><a class="anchor" id="autotoc_md735"></a>
Loading and running on CCS</h2>
<p>See <a class="el" href="CCS_LAUNCH_PAGE.html">CCS Launch, Load and Run</a> page for details on how to load and run binaries on EVM using CCS. Also, see <a class="el" href="EVM_SETUP_PAGE.html#CCS_UART_TERMINAL">Setup UART Terminal</a> section for information on how to open a UART terminal inside CCS.</p>
<h2><a class="anchor" id="ICSS_EMAC_DEBUG_GUIDE_CHECKING_LINK_STATUS"></a>
Checking Link Status</h2>
<p>Link Status is available as an array <code>linkStatus</code> in <code>ICSS_EMAC_Object</code>. The status is updated in the Link ISR function (<code>ICSS_EMAC_linkISR</code>). It can be read by putting <code>"((ICSS_EMAC_Object *)(icssEmacHandle-&gt;object))-&gt;linkStatus"</code> in the "Expressions" window of CCS (It can be opened in CCS from View-&gt;Expressions).</p>
<p>It is possible that the link interrupt is configured incorrectly or MDIO is not triggering the interrupts. In which case one needs to put a breakpoint in the ISR <code>ICSS_EMAC_linkISR</code> and disconnect or connect the cable on any one port. The breakpoint should get hit, if it does not then there is some issue with the interrupt configuration.</p>
<p>In case different PHYs (compared to those on EVM) are used that, the PHY status registers may be read incorrectly and that might lead to some issues. Please consult the porting guide and reference manual for the specific PHY to figure out where the issue could be.</p>
<h2><a class="anchor" id="autotoc_md736"></a>
Checking if Receive is working</h2>
<p>The receive path has been explained in <a class="el" href="ICSS_EMAC_DESIGN.html#ICSS_EMAC_DESIGN_DATA_PATH_RX">Rx Data Path</a> section. Rx issues can manifest themselves in several ways, the following table covers most of them (not exhaustively).</p>
<table class="doxtable">
<tr>
<th>Issue </th><th>Probable Cause  </th></tr>
<tr>
<td>Host not receiving Multicast/Broadcast frames </td><td><ul>
<li>Rx interrupt not configured correctly</li>
<li>Firmware not receiving</li>
<li>Storm Prevention enabled</li>
<li>Rx is disabled  </li>
</ul>
</td></tr>
<tr>
<td>Unicast Packets (for Host) being dropped </td><td><ul>
<li>Rx interrupt not configured correctly</li>
<li>Firmware not receiving</li>
<li>Storm Prevention enabled</li>
<li>Rx is disabled</li>
<li>Interface MAC not configured correctly  </li>
</ul>
</td></tr>
<tr>
<td>Multicast/Broadcast frames not being forwarded </td><td><ul>
<li>Storm Prevention enabled</li>
<li>Firmware not receiving</li>
<li>Rx is disabled  </li>
</ul>
</td></tr>
<tr>
<td>Unicast frames (not for Host) not being forwarded </td><td><ul>
<li>Firmware not receiving</li>
<li>Rx is disabled  </li>
</ul>
</td></tr>
<tr>
<td>Packets are getting dropped </td><td><ul>
<li>Storm Prevention enabled</li>
<li>Data is coming in too fast. See <a class="el" href="ICSS_EMAC_DESIGN.html#ICSS_EMAC_DESIGN_INTERRUPT_PACING">Interrupt Pacing</a> section to understand this behavior  </li>
</ul>
</td></tr>
</table>
<p>The first step is to identify the exact problem. To do that please perform these steps in order.</p>
<ol type="1">
<li>Check if Rx is disabled : It is possible to disable Rx in firmware through IOCTL. This is controlled through a location in ICSS memory. Check the memory correspnding to <code>portControlAddr</code> configured in <a class="el" href="structICSS__EMAC__FwStaticMmap.html">ICSS_EMAC_FwStaticMmap</a>. See <a class="el" href="ICSS_EMAC_DEBUG_GUIDE.html#ICSS_EMAC_DEBUG_GUIDE_ACCESSING_MEMORY">Accessing Memory</a> for details how to check this memory. <code>0x1</code> value for this byte means Rx is disabled , and <code>0x0</code> means Rx is enabled. Check this as a very first step. It is not a common error but it is possible that user is invoking the IOCTL for disabling by mistake.</li>
<li>Check if firmware is receiving packets : See <a class="el" href="ICSS_EMAC_DEBUG_GUIDE.html#ICSS_EMAC_DEBUG_GUIDE_CHECKING_STATISTICS">Checking Statistics</a> section to find out if PRU is receiving the frames. Failure to receive frames in firmware can indicate other issues like corrupted frames, link negotiation failure or PHY related issues.</li>
<li>Check if Rx interrupt is being asserted : This can be one of the reasons why Host would not receive packets. Put a break point in <code>ICSS_EMAC_rxInterruptHandler</code> and send a single packet using any PC based tool. The ISR should get hit. Please check if the interrupt numbers for being used for ARM are correct and as expected based on the firmware.</li>
<li>Check if Packets are being copied in driver : If the interrupt is asserted but packets do not reach the application, check Host statistics (as shown in <a class="el" href="ICSS_EMAC_DEBUG_GUIDE.html#ICSS_EMAC_DEBUG_GUIDE_CHECKING_STATISTICS">Checking Statistics</a>) to verify if packets are being received correctly in the driver. Refer to the <a class="el" href="ICSS_EMAC_DESIGN.html#ICSS_EMAC_DESIGN_DATA_PATH_RX">Rx Data Path</a> and put a breakpoint in <code>ICSS_EMAC_osRxTaskFnc</code> used for creating <code>RxTask</code> task. Step through to verify that the priority is set correctly and packets are being copied properly. If interrupt is being asserted correctly but packet length is zero it indicates some data corruption in the receive queues or firmware behaving incorrectly, this scenario should not occur.</li>
<li>Check if Storm prevention is enabled : This is one of the most common reasons why throughput may get lowered or if the threshold is set incorrectly packets may not reach Host at all. Check if storm prevention module is enabled by checking the <code>"((ICSS_EMAC_Object *)(icssEmacHandle-&gt;object))-&gt;stormPrev"</code> for both ports in the "Expressions" window of CCS. Additionally one should check the statistics to see if <code>stormPrevCounter</code>, <code>stormPrevCounterMC</code> or <code>stormPrevCounter</code> in <a class="el" href="structICSS__EMAC__PruStatistics.html">ICSS_EMAC_PruStatistics</a> is getting incremented (See <a class="el" href="ICSS_EMAC_DEBUG_GUIDE.html#ICSS_EMAC_DEBUG_GUIDE_CHECKING_STATISTICS">Checking Statistics</a>).</li>
<li>Check Interface MAC : The firmware compares the interface MAC written to the PRU memory by the Host against the incoming packets destination MAC to verify if the packet must be forwarded to Host or cut-through. Please check the memory correspnding to <code>interfaceMacAddrOffset</code> configured in <a class="el" href="structICSS__EMAC__FwStaticMmap.html">ICSS_EMAC_FwStaticMmap</a> and verify if the MAC value is what you are expecting it to be. See <a class="el" href="ICSS_EMAC_DEBUG_GUIDE.html#ICSS_EMAC_DEBUG_GUIDE_ACCESSING_MEMORY">Accessing Memory</a> for details how to check this memory.</li>
<li>Queue Overflow : If too many packets are received on a single queue without Host emptying them out then overflow may occur, packets will be lost in such a scenario. This is somewhat related to throughput issues but may occur independently as well.</li>
<li>Check throughput : This is applicable in case everything else appears to be correct but the number of packets reaching the Host is not 100% of the transmitted value. This can happen because of two reasons:<ol type="a">
<li>Data rate is too fast and interrupt pacing is disabled.</li>
<li>Processing on Host is too slow and driver cannot cope with the rate at which firmware is putting data in the queue. In such a scenario first turn on Interrupt pacing to find if it solves the issue (interrupt pacing has its own limitations, refer to <a class="el" href="ICSS_EMAC_DESIGN.html#ICSS_EMAC_DESIGN_INTERRUPT_PACING">Interrupt Pacing</a> to know more about it). If issue is still not resolved then try to find the throughput by comparing the number of packets received on the Host vs that in the firmware.</li>
</ol>
</li>
<li>More on Throughput : If throughput is low then try to find out how the Rx processing on Host can be sped up or if any other high priority task is blocking the execution of <code>RxTask</code>.</li>
</ol>
<h2><a class="anchor" id="autotoc_md737"></a>
Checking if Transmit is working</h2>
<p>Tx is much more reliable and there are far fewer issues related to it when compared to Rx. The transmit path has been explained in <a class="el" href="ICSS_EMAC_DESIGN.html#ICSS_EMAC_DESIGN_DATA_PATH_TX">Tx Data Path</a> section.</p>
<p>Transmit issues can be classified into two types:</p>
<ol type="1">
<li>Cut-through issues : Packets received on one port and meant to go out of the opposite port. (Not applicable to EMAC)</li>
<li>Transmit from Host : Packets sent out from the Host on any one port.</li>
</ol>
<p>As a first step please check the statistics (as shown in <a class="el" href="ICSS_EMAC_DEBUG_GUIDE.html#ICSS_EMAC_DEBUG_GUIDE_CHECKING_STATISTICS">Checking Statistics</a>) on firmware as well as Host to see if any packets have been sent out. Try to trace where the issue is by comparing transmit statistics for Host and firmware.</p>
<p>The probable causes for transmit not working are listed below. This can also be used as a checklist for debugging.</p>
<ol type="1">
<li>Link down : The link event is mapped to an ISR <code>ICSS_EMAC_linkISR</code> which in turn triggers call to another API <code>ICSS_EMAC_updatePhyStatus</code> to update the link status in firmware. If this is not done correctly then it is possible that firmware will read the event as link down even though physically the link is up. Please check the link status to make sure that this is not the case. The Tx API checks for link and will not transmit if the link is down so this issue is more relevant to cut-through/store-forward. Please see <a class="el" href="ICSS_EMAC_DEBUG_GUIDE.html#ICSS_EMAC_DEBUG_GUIDE_CHECKING_LINK_STATUS">Checking Link Status</a> for details on how to check link status.</li>
<li>Incorrect speed : The link ISR also checks for speed and duplexity values. The values are written to in the <code>ICSS_EMAC_updatePhyStatus</code> function, if the speed is read incorrectly then it is possible that firmware will not send out packets or may send out garbage. In such a scenario firmware statistics will count the packets as successful transmit but Tx might not actually happen. The quickest way to debug this issue is to read the ICSS memory directly in CCS memory window. Interface speed is written directly in memory at the offset mentioned <code>phySpeedOffset</code> configured in <a class="el" href="structICSS__EMAC__FwStaticMmap.html">ICSS_EMAC_FwStaticMmap</a>. Please check the value and compare with the actual interface speed. See <a class="el" href="ICSS_EMAC_DEBUG_GUIDE.html#ICSS_EMAC_DEBUG_GUIDE_ACCESSING_MEMORY">Accessing Memory</a> for details how to check this memory.</li>
<li>Incorrect pinmux for Collision/Carrier Sense : This is applicable in case of developers using their custom boards, it is important that the collision and carrier sense signals be wired correctly because the transmit code relies on these two signals to implement half duplex functionality and wrong values may result in transmit problems. If there is an issue with pinmuxing for these two pins, it is recommended that half duplex functionality be disabled. Half Duplex functionality can be controlled in the SysConfig.</li>
<li>Queue contention issues : Looking at the <a class="el" href="ICSS_EMAC_DESIGN.html#ICSS_EMAC_DESIGN_QOS">Quality of Service and Queues</a> scheme, it is possible that there is a contention for the transmit queue when both Host and the opposite port are trying to transmit on the same port. In such cases if there are too many packets vying for the contention queue they will be dropped. Such conditions are rare.</li>
<li>Queue overflow : As the name suggests if too many packets are sent out on a single queue then overflow can happen and packets may get lost.</li>
</ol>
<h2><a class="anchor" id="ICSS_EMAC_DEBUG_GUIDE_CHECKING_STATISTICS"></a>
Checking Statistics</h2>
<p>Statistics form the core of debugging so this section is very important. A brief introduction to statistics has been provided in <a class="el" href="ICSS_EMAC_DESIGN.html#ICSS_EMAC_DESIGN_STATISTICS">Statistics</a> section. This part explains how to use it for the purpose of debugging.</p>
<p>As previously explained, statistics can be divided into two groups</p><ul>
<li>Statistics on PRU</li>
<li>Statistics on Host</li>
</ul>
<p>Host statistics are a subset of firmware based statistics except some specialized statistics like <code>rxUnknownProtocol</code> and <code>linkBreak</code>. This property can be used to find out how many packets are being received in the firmware and how many are reaching Host.</p>
<p>Following are two ways of reading these statistics:</p>
<ul>
<li>IOCTL : <a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga7d6c646018a797be02688b661d62f31c">ICSS_EMAC_ioctl</a> API should be called with <a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga88236cd644437bc364b8d53c460dd82a">ICSS_EMAC_IOCTL_STATS_CTRL</a> as <code>ioctlCommand</code>, <a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga2dc9bd12be449f2cba6a0d5e5d610450">ICSS_EMAC_IOCTL_STAT_CTRL_GET</a> as <code>ioctlParams.command</code> and a pointer to <a class="el" href="structICSS__EMAC__PruStatistics.html">ICSS_EMAC_PruStatistics</a> as <code>ioctlParams.ioctlVal</code> to access the PRU statistics.</li>
<li>CCS : When using CCS the statistics can be read directly through the ICSS EMAC handle. Host statistics are available through <code>"((ICSS_EMAC_Object *)(icssEmacHandle-&gt;object))-&gt;hostStat"</code> , while PRU statistics are available through <code>"(ICSS_EMAC_PruStatistics *)((((*(((ICSS_EMAC_Object *)(icssEmacHandle-&gt;object)))).fwStaticMMap).statisticsOffset + (*((*((*(((ICSS_EMAC_Object *)(icssEmacHandle-&gt;object)))).pruicssHandle)).hwAttrs)).pru0DramBase))"</code> in the "Expressions" window of CCS.</li>
</ul>
<h1><a class="anchor" id="ICSS_EMAC_DEBUG_GUIDE_ACCESSING_MEMORY"></a>
Accessing Memory</h1>
<p>This section explains how to access ICSS memory. Various firmware offsets are configured using <a class="el" href="structICSS__EMAC__FwStaticMmap.html">ICSS_EMAC_FwStaticMmap</a>, <a class="el" href="structICSS__EMAC__FwDynamicMmap.html">ICSS_EMAC_FwDynamicMmap</a>, <a class="el" href="structICSS__EMAC__FwVlanFilterParams.html">ICSS_EMAC_FwVlanFilterParams</a> and <a class="el" href="structICSS__EMAC__FwMulticastFilterParams.html">ICSS_EMAC_FwMulticastFilterParams</a> structures, which are a part of <a class="el" href="structICSS__EMAC__Params.html">ICSS_EMAC_Params</a> needed for <a class="el" href="group__NETWORKING__ICSS__EMAC__MODULE.html#ga3dfa23ace97b9812cbc71184186b8e52">ICSS_EMAC_open</a> API call.</p>
<p>The Shared RAM address and DRAM base addresses for Port 1 and Port 2 can be obtained by adding <code>"(*((*((*(((ICSS_EMAC_Object *)(icssEmacHandle-&gt;object)))).pruicssHandle)).hwAttrs))"</code> in the "Expressions" window of CCS.</p>
<p>For example on AM64x, if <code>portMacAddr</code> location needs to be accessed for Port 0, then following steps give the value of the location using the "Memory Browser" of CCS.</p>
<table style="border: 0 px; margin-left: auto; margin-right: auto">
<tr>
<td><div class="image">
<img src="ICSS_EMAC_Debug_Memory_Access_1.PNG" alt=""/>
</div>
 </td><td><div class="image">
<img src="ICSS_EMAC_Debug_Memory_Access_2.PNG" alt=""/>
</div>
 </td><td><div class="image">
<img src="ICSS_EMAC_Debug_Memory_Access_3.PNG" alt=""/>
</div>
  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md738"></a>
Using ROV to Debug RTOS</h1>
<p>For more details, see <a class="el" href="ROV_INTRO_PAGE.html">Using SDK with Real-time Object View (ROV)</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
