<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="shortcut icon" href="favicon.png" type="image/png">    
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<title>AM64x MCU+ SDK: Ethernet PHY Integration Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<style>
.tinav {
    background: #c00;
    /* height: 41.375px; */
    height: 30px;
    }
</style>    
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 40px;">
  <td id="projectlogo"><a href="https://www.ti.com"><img alt="Logo" src="ti_logo.svg"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AM64x MCU+ SDK
   &#160;<span id="projectnumber">08.01.00</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<div class=tinav></div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('enetphy_guide_top.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Ethernet PHY Integration Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#enetphy_guide_intro">Introduction</a></li>
<li class="level1"><a href="#enetphy_guide_driver">PHY Driver</a><ul><li class="level2"><a href="#enetphy_guide_device_specific">Device-Specific Drivers</a></li>
<li class="level2"><a href="#enetphy_guide_binding">PHY to Driver Binding</a></li>
</ul>
</li>
<li class="level1"><a href="#enetphy_guide_implementing">Implementing a New PHY Driver</a></li>
<li class="level1"><a href="#enetphy_guide_appendix">Appendix</a><ul><li class="level2"><a href="#enetphy_guide_appendix_a">Appendix A</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_components_networking_enet_lld_phy_integration"></a></p>
<h1><a class="anchor" id="enetphy_guide_intro"></a>
Introduction</h1>
<p>The Ethernet PHY driver is currently part of the Enet low-level driver (LLD), it's dedicated to Ethernet PHY management. It implements a state machine required to handle the lifecycle of PHYs, from initialization to link establishment.</p>
<p>The PHY submodule interacts with an underlying MDIO hardware through a simple MDIO driver abstraction (see <a class="el" href="structEnetPhy__Mdio.html">EnetPhy_Mdio</a>) in order to perform operations like detecting alive and/or linked PHYs, and for PHY register accesses. The relationship between PHY, MDIO and Enet LLD integration layer is shown below.</p>
<p><img src="EnetLLD_Diagram.png" alt="" class="inline" title="Enet Low-Level Driver Block Diagram"/>   </p>
<p>Currently, the PHY driver supports only Clause-22 devices. Clause-45 devices are not supported, but read and write helper functions are provided.</p>
<h1><a class="anchor" id="enetphy_guide_driver"></a>
PHY Driver</h1>
<p>The top-layer of PHY driver is located at <code>&lt;ENET_LLD&gt;/src/phy/enetphy.c</code>. This layer implements the basic APIs that are needed to communicate the driver, such as <code><a class="el" href="group__DRV__ENETPHY.html#ga3f5ded0b10bca14051e55f1a01402aaf" title="Open the PHY driver.">EnetPhy_open()</a></code>, <code><a class="el" href="group__DRV__ENETPHY.html#ga82babbc2e9c65ac5dc541c6fc8e33ca3" title="Run PHY state machine.">EnetPhy_tick()</a></code>, <code><a class="el" href="group__DRV__ENETPHY.html#ga1d69a2547cc8cb17c9ccd397ac164378" title="Close the PHY driver.">EnetPhy_close()</a></code>, etc.</p>
<p>The Enet LLD is capable of supporting multiple PHYs running simultaneously; each PHY has its own driver instance, its own state machine and hence will follow independent lifecycle from other PHYs.</p>
<p>The lifecycle of the PHYs is handled by the PHY driver via a state machine implementation. This state machine is composed of the following states:</p>
<ul>
<li><b>FINDING</b>: The driver will remain in this state until the PHY is detected as alive and a device-specific PHY driver has been bound to it.</li>
<li><b>FOUND</b>: The driver will initiate (soft) reset if requested in PHY configuration.</li>
<li><b>RESET_WAIT</b>: The driver will remain in this state while waiting for reset to complete.</li>
<li><b>ENABLE</b>: The driver will put the PHY in normal mode, perform PHY device-specific extended configuration and get common capabilities supported by the MAC port and local PHY device. Depending on the requested mode (auto-negotiation or manual), the PHY will either restart auto-negotiation or manually configure speed and duplexity.</li>
<li><b>LOOPBACK</b>: Last state if PHY loopback is enabled.</li>
<li><b>NWAY_START</b>: The driver will remain in this state while waiting for auto-negotiation to start.</li>
<li><b>NWAY_WAIT</b>: The driver will remain in this state while waiting for auto-negotiation to complete.</li>
<li><b>LINK_WAIT</b>: The driver will remain in this state while waiting for link up.</li>
<li><b>LINKED</b>: The PHY will remain in this state until the link is down, i.e. cable disconnection.</li>
</ul>
<p>The diagram in the figure below provides a simplified view of the state transitions of the PHY state machine.</p>
<p><img src="EnetPhy_FSM_SimplifiedView.png" alt="" class="inline" title="Simplified View of PHY State Machine"/>   </p>
<p>Refer to <a class="el" href="enetphy_guide_top.html#enetphy_guide_appendix_a">Appendix A</a> for a more detailed view of the PHY state machine.</p>
<h2><a class="anchor" id="enetphy_guide_device_specific"></a>
Device-Specific Drivers</h2>
<p>The PHY driver model has been designed to partition device-specific operations from device-agnostic common operations. The former are implemented by PHY device specific drivers, while the latter can be carried out directly by the main PHY driver.</p>
<p>This model facilitates the addition of new drivers for PHY devices not yet supported in the Enet LLD. The <code>EnetPhy_Drv</code> structure is defined as the interface that device specific drivers must implement. Since this structure is not exposed to the application, its scope is internal to the Enet LLD.</p>
<p><img src="EnetPhy_Drv.png" alt="" class="inline" title="Ethernet PHY Driver Interface"/>   </p>
<p>The members of the <code>EnetPhy_Drv</code> structure can be mandatory or optional in nature. Optional members can be set to NULL if the PHY doesn't provide an implementation for them. The list below provides a description of the purpose of each <code>EnetPhy_Drv</code> member.</p>
<ul>
<li><b>name</b>: Driver name.</li>
<li><b>isPhyDevSupported()</b>: Function pointer used by the main PHY driver to check if this device specific driver support a given PHY hardware identified by its version (OUI). This function is used during PHY device to driver binding.</li>
<li><b>isMacModeSupported()</b>: The main PHY driver will call this function to check if the device specific driver supports the requested MAC mode (MII, RMII, RGMII, SGMII, etc).</li>
<li><b>config()</b>: The main PHY driver will call this function to allow the driver to perform any device-specific extended configuration. This function is optional and will not be called if the driver sets the function pointer to <code>NULL</code>.</li>
<li><b>reset()</b>: Device specific reset. This function is optional and will not be called if the driver sets the function pointer to <code>NULL</code>.</li>
<li><b>isResetComplete()</b>: The main PHY driver will call this function to check if the reset operation triggered by <code>reset()</code> function has completed. If <code>reset()</code> is provided, <code>isResetComplete()</code> must be provided as well.</li>
<li><b>readExtReg()</b>: The main PHY driver will call this function to read extended registers.</li>
<li><b>writeExtReg()</b>: The main PHY driver will call this function to write extended registers.</li>
<li><b>printRegs()</b>: The main PHY driver will call this function when <a class="el" href="group__DRV__ENETPHY.html#ga86d2852ee8d820639c56aa26104965fc" title="Print all PHY registers.">EnetPhy_printRegs()</a> is called. This function is optional and will not be called if the driver sets the function pointer to <code>NULL</code>.</li>
</ul>
<p>The current version of Enet LLD includes the following PHY drivers:</p><ul>
<li>Generic PHY driver.</li>
<li>TI <a href="http://www.ti.com/lit/ds/symlink/dp83867cr.pdf">DP83867</a> RGMII PHY driver.</li>
<li>TI <a href="https://www.ti.com/lit/ds/symlink/dp83869hm.pdf">DP83869</a> RGMII PHY driver.</li>
<li>TI <a href="https://www.ti.com/lit/ds/symlink/dp83822i.pdf">DP83822</a> RMII PHY driver.</li>
<li>VSC8514 QSGMII PHY driver.</li>
</ul>
<p>The generic PHY driver is a special case because its implementation is limited to IEEE-Standard MII registers. Reuse of PHY generic function by other device-specific drivers is possible when their <code>EnetPhy_Drv</code> implementation doesn't deviate from standard. The diagram in figure below shows the reuse of extended register read/write functions by the DP83867 driver.</p>
<p><img src="EnetPhy_Drv_Hierarchy.png" alt="" class="inline" title="Ethernet PHY Driver Hierarchy"/>   </p>
<p>Device specific drivers can be found at <code>&lt;ENET_LLD&gt;/src/phy/*</code>.</p>
<h2><a class="anchor" id="enetphy_guide_binding"></a>
PHY to Driver Binding</h2>
<p>The PHY-to-driver binding is the process of selecting the best driver for a PHY device based on the device's unique identifier. This process is done by the main PHY driver upon <em>alive</em> detection of a PHY device and takes place in the <em>FINDING</em> state.</p>
<p>The device unique identifier is read from PHYIDR1 and PHYIDR2 registers and populated into a structure of type <a class="el" href="structEnetPhy__Version.html" title="PHY version (ID).">EnetPhy_Version</a>.</p>
<p><img src="EnetPhy_Version.png" alt="" class="inline" title="Ethernet PHY Version"/>   </p>
<p>The main PHY driver has a <code>gEnetPhyDrvs</code> array which contains all device specific drivers that are registered and that will participate in the search for the best driver for the PHY that had been recently discovered.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group__DRV__ENETPHY.html#gae2adc95bf3a449171fbe12916ac9ec6d">EnetPhyDrv_Handle</a> gEnetPhyDrvs[] =</div>
<div class="line">{</div>
<div class="line">    &amp;gEnetPhyDrvVsc8514,   <span class="comment">/* VSC8514 */</span></div>
<div class="line">    &amp;gEnetPhyDrvDp83822,   <span class="comment">/* DP83822 */</span></div>
<div class="line">    &amp;gEnetPhyDrvDp83867,   <span class="comment">/* DP83867 */</span></div>
<div class="line">    &amp;gEnetPhyDrvDp83869,   <span class="comment">/* DP83869 */</span></div>
<div class="line">    &amp;gEnetPhyDrvGeneric,   <span class="comment">/* Generic PHY - must be last */</span></div>
<div class="line">};</div>
</div><!-- fragment --><p>In the search process, the main PHY driver will call the <code>isPhyDevSupported()</code> function of each registered driver. The drivers will use the <a class="el" href="structEnetPhy__Version.html" title="PHY version (ID).">EnetPhy_Version</a> which is passed as an argument in order to determine whether the device is supported or not. If it is, <code>isPhyDevSupported()</code> must return <code>true</code> and the search process ends. If not, the search continues with the next registered device.</p>
<p>The generic PHY (which must be the last one in the <code>gEnetPhyDrvs</code> array) will be bound to the device if no other driver can support a given PHY, but the PHY full functionality can't be guaranteed.</p>
<h1><a class="anchor" id="enetphy_guide_implementing"></a>
Implementing a New PHY Driver</h1>
<p>The following list of steps is provided as guideline when adding a new PHY driver for a device which is not supported by Enet LLD.</p>
<ul>
<li>Create the public PHY specific header file at <code>&lt;ENET_LLD&gt;/include/phy</code>.<ul>
<li>This header file should have the device extended configuration structure definition (if applicable) as well as auxiliary structures or enumerations. <img src="MyPhy_h.png" alt="" class="inline"/>   </li>
</ul>
</li>
<li>Create new source file and private header file (if needed) for the new PHY driver at <code>&lt;ENET_LLD&gt;/src/phy</code>. <img src="MyPhy_c.png" alt="" class="inline"/>   </li>
<li>Declare a global structure of type <code>EnetPhy_Drv</code>, but don't make it static. This variable will be later accessed as an extern symbol by the Ethernet PHY driver.</li>
<li>Initialize <code>EnetPhy_Drv</code> structure with the function pointers of the device specific implementation.<ul>
<li>Look for reuse of PHY generic functions if a device specific implementation is not needed.</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line">EnetPhy_Drv gEnetPhyDrvMyDrv =</div>
<div class="line">{</div>
<div class="line">    .name               = <span class="stringliteral">&quot;My PHY driver&quot;</span>,</div>
<div class="line">    .isPhyDevSupported  = MyPhy_isPhyDevSupported,</div>
<div class="line">    .isMacModeSupported = MyPhy_isMacModeSupported,</div>
<div class="line">    .config             = MyPhy_config,</div>
<div class="line">    .reset              = MyPhy_reset,</div>
<div class="line">    .isResetComplete    = MyPhy_isResetComplete,</div>
<div class="line">    .runComplianceTest  = NULL,</div>
<div class="line">    .readExtReg         = GenericPhy_readExtReg,</div>
<div class="line">    .writeExtReg        = GenericPhy_writeExtReg,</div>
<div class="line">    .printRegs          = MyPhy_printRegs,</div>
<div class="line">};</div>
</div><!-- fragment --><ul>
<li>Declare the variable of type <code>EnetPhy_Drv</code> as extern in main PHY driver located at <code>&lt;ENET_LLD&gt;/src/phy/enetphy.c</code>. Also, add it to the <code>gEnetPhyDrvs</code> array.</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">extern</span> EnetPhy_Drv gEnetPhyDrvGeneric;</div>
<div class="line"><span class="keyword">extern</span> EnetPhy_Drv gEnetPhyDrvDp83822;</div>
<div class="line"><span class="keyword">extern</span> EnetPhy_Drv gEnetPhyDrvDp83867;</div>
<div class="line"><span class="keyword">extern</span> EnetPhy_Drv gEnetPhyDrvDp83869;</div>
<div class="line"><span class="keyword">extern</span> EnetPhy_Drv gEnetPhyDrvVsc8514;</div>
<div class="line"><span class="keyword">extern</span> EnetPhy_Drv gEnetPhyDrvMyDrv;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__DRV__ENETPHY.html#gae2adc95bf3a449171fbe12916ac9ec6d">EnetPhyDrv_Handle</a> gEnetPhyDrvs[] =</div>
<div class="line">{</div>
<div class="line">    &amp;gEnetPhyDrvMyDrv,     <span class="comment">/* My PHY driver */</span></div>
<div class="line">    &amp;gEnetPhyDrvVsc8514,   <span class="comment">/* VSC8514 */</span></div>
<div class="line">    &amp;gEnetPhyDrvDp83822,   <span class="comment">/* DP83822 */</span></div>
<div class="line">    &amp;gEnetPhyDrvDp83867,   <span class="comment">/* DP83867 */</span></div>
<div class="line">    &amp;gEnetPhyDrvDp83869,   <span class="comment">/* DP83869 */</span></div>
<div class="line">    &amp;gEnetPhyDrvGeneric,   <span class="comment">/* Generic PHY - must be last */</span></div>
<div class="line">};</div>
</div><!-- fragment --><ul>
<li>Add the PHY source file to <code>SRCS_COMMON</code> in the Ethernet PHY driver makefile locate at <code>&lt;ENET_LLD&gt;/src/phy/makefile</code>.</li>
</ul>
<div class="fragment"><div class="line">SRCS_COMMON += enetphy.c generic_phy.c</div>
<div class="line">SRCS_COMMON += dp83869.c dp83867.c dp83822.c vsc8514.c</div>
</div><!-- fragment --><ul>
<li>PHY driver directory is already part of the <code>SRCDIR</code>, so just the source name needs to be added.</li>
</ul>
<h1><a class="anchor" id="enetphy_guide_appendix"></a>
Appendix</h1>
<h2><a class="anchor" id="enetphy_guide_appendix_a"></a>
Appendix A</h2>
<p>Detailed view of the PHY state machine.</p>
<p><img src="EnetPhy_FSM.png" alt="" class="inline" title="Detailed View of PHY State Machine"/>    </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div class="ttc" id="agroup__DRV__ENETPHY_html_gae2adc95bf3a449171fbe12916ac9ec6d"><div class="ttname"><a href="group__DRV__ENETPHY.html#gae2adc95bf3a449171fbe12916ac9ec6d">EnetPhyDrv_Handle</a></div><div class="ttdeci">struct EnetPhy_Drv_s * EnetPhyDrv_Handle</div><div class="ttdoc">PHY specific driver handle.</div><div class="ttdef"><b>Definition:</b> enetphy.h:501</div></div>
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.20 </li>
  </ul>
</div>
</body>
</html>
